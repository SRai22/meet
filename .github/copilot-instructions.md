# LiveKit Meet - AI Agent Guidelines

## Project Overview
Open-source video conferencing app built on LiveKit Components, Next.js 15 (App Router), and TypeScript. Production-ready with E2EE, recording, noise filtering, and performance optimizations. **Configured for local network deployment with HTTPS support.**

## Recent Changes (Feb 2026)

### Docker & Network Configuration
- **Standalone deployment**: next.config.js configured with `output: 'standalone'` for Docker optimization
- **Network access**: Changed from localhost to host IP (192.168.128.8) for multi-device support
- **LiveKit server**: Added `--node-ip` flag for proper WebRTC ICE candidate advertisement
- **HTTPS proxy**: nginx container on port 8443 with self-signed certificates for secure getUserMedia access
- **Background images**: Git LFS images disabled in CameraSettings.tsx to allow builds without LFS

### New Features
- **"Join Existing" tab** ([app/page.tsx](app/page.tsx)): Displays active rooms, auto-refreshes every 5s
- **Active rooms API** ([app/api/rooms/active/route.ts](app/api/rooms/active/route.ts)): Uses RoomServiceClient to list rooms with participants

## Build & Development

```bash
pnpm install              # Install dependencies
pnpm dev                  # Dev server on :3000
pnpm build               # Production build (required for Docker)
pnpm test                # Run vitest tests
pnpm lint:fix            # Auto-fix linting issues
pnpm format:write        # Auto-format code

# Docker (from project root)
docker compose build meet         # Build container
docker compose up livekit meet meet-nginx  # Start full stack

# SSL Certificate (one-time setup)
cd meet && ./generate-cert.sh     # Generate self-signed cert
```

**Required env vars**: 
- Server-side: `LIVEKIT_URL`, `LIVEKIT_API_KEY`, `LIVEKIT_API_SECRET`
- Client-side: `NEXT_PUBLIC_LIVEKIT_URL` (build arg)

## Network Configuration

### Local Network Access
For multi-device access, configure with host machine's IP:
- **LiveKit server**: `command: --dev --bind "0.0.0.0" --node-ip "192.168.128.8"`
- **Environment vars**: Use `ws://192.168.128.8:7880` instead of `ws://localhost:7880`
- **HTTPS access**: `https://192.168.128.8:8443` (nginx proxy with self-signed cert)
- **HTTP fallback**: `http://192.168.128.8:3000` (insecure context, limited features)

### Why HTTPS is Required
Browsers block `navigator.mediaDevices` and `crypto.randomUUID()` in non-localhost HTTP contexts:
- ❌ Remote devices on HTTP: Cannot access camera/mic or send chat
- ✅ Remote devices on HTTPS: Full functionality after accepting certificate warning
- ✅ Localhost HTTP: Full functionality (browser exception)

### Self-Signed Certificates
Located in `meet/certs/` (generated by `generate-cert.sh`):
- nginx mounts as read-only: `./meet/certs:/etc/nginx/certs:ro`
- Users must accept browser security warning once per device
- Alternative: Use browser flags for HTTP (chrome://flags/#unsafely-treat-insecure-origin-as-secure)

## Architecture Patterns

### Server/Client Component Split
Next.js App Router pattern: server components fetch data, client components (`"use client"`) handle interactivity.
- **Server**: [app/rooms/[roomName]/page.tsx](app/rooms/[roomName]/page.tsx) - async data, SEO
- **Client**: [app/rooms/[roomName]/PageClientImpl.tsx](app/rooms/[roomName]/PageClientImpl.tsx) - LiveKit SDK, hooks, state

### LiveKit Integration Flow
1. User enters PreJoin → selects devices
2. Fetch token from `/api/connection-details` (JWT generation)
3. Create `Room` with options, connect with token
4. Wrap UI in `<RoomContext.Provider value={room}>`
5. Render `<VideoConference>` with custom components

**Reference**: [app/rooms/[roomName]/PageClientImpl.tsx](app/rooms/[roomName]/PageClientImpl.tsx#L80-L120)

### Room Configuration (Critical)
Always configure rooms with these LiveKit patterns:
```typescript
const room = new Room({
  videoCaptureDefaults: { resolution: VideoPresets.h720 },
  publishDefaults: { 
    videoSimulcastLayers: [VideoPresets.h540, VideoPresets.h216],
    videoCodec: 'vp9' 
  },
  adaptiveStream: true,  // Auto quality adjustment
  dynacast: true,        // Dynamic track subscription
  e2ee: e2eeEnabled ? { keyProvider, worker } : undefined
});
```

### E2EE via URL Hash (Unique Pattern)
Passphrase stored in URL hash (client-side only, never sent to server):
```typescript
// Encode when joining: /rooms/abc-123#encodedPassphrase
encodePassphrase(passphrase) // from lib/client-utils
// Decode in component: location.hash.substring(1)
decodePassphrase(hash)
// Initialize worker: lib/useSetupE2EE.ts
```
**Reference**: [lib/useSetupE2EE.ts](lib/useSetupE2EE.ts)

## Code Style

### Import Patterns
```typescript
// LiveKit components - always from -react
import { VideoConference, PreJoin } from '@livekit/components-react';
import { Room, VideoPresets } from 'livekit-client';
// Local utilities - use @ alias
import { decodePassphrase } from '@/lib/client-utils';
```

### Styling
- **CSS Modules** for components: `styles/[Component].module.css`
- **Global styles**: `styles/globals.css`
- **LiveKit styles**: Imported at root (`@livekit/components-styles`)
- **Inline styles** for dynamic/conditional formatting
- **CSS variables**: Use `var(--lk-bg)`, `var(--lk-accent-bg)` for theming
- **Dark theme default**: `data-lk-theme="default"` on root

### React Patterns
- Use `useMemo` for computed values (room options, track refs)
- Use `useCallback` for handlers passed to children
- Destructure hooks: `const { cameraTrack, localParticipant } = useLocalParticipant();`
- Always check `isLocalTrack(track)` before operations

## Key Utilities

### [lib/client-utils.ts](lib/client-utils.ts)
```typescript
generateRoomId()         // 'abcd-1234' format
encodePassphrase()       // URL-safe E2EE passphrase
isLowPowerDevice()      // CPU detection < 6 cores
```

### [lib/getLiveKitURL.ts](lib/getLiveKitURL.ts)
Regional routing for LiveKit Cloud:
```typescript
getLiveKitURL('myproject.livekit.cloud', 'eu')
// → 'wss://myproject.eu.production.livekit.cloud'
```

### [lib/usePerfomanceOptimiser.ts](lib/usePerfomanceOptimiser.ts)
Auto-detects low-power devices and reduces video quality - already integrated, don't duplicate logic.

## API Routes

### [app/api/connection-details/route.ts](app/api/connection-details/route.ts)
Generates JWT tokens with 5-minute TTL. Uses cookies to persist participant identity.
```typescript
const at = new AccessToken(API_KEY, API_SECRET, {
  identity: `${name}__${randomPostfix}`,
  name: participantName
});
at.addGrant({ room, roomJoin: true, canPublish: true, ... });
return at.toJwt();
```

### [app/api/rooms/active/route.ts](app/api/rooms/active/route.ts)
**NEW**: Lists active rooms with participants for "Join Existing" feature.
```typescript
const roomService = new RoomServiceClient(LIVEKIT_URL, API_KEY, API_SECRET);
const rooms = await roomService.listRooms();
// Filter to rooms with numParticipants > 0
```
Returns: `{ rooms: [{ name, numParticipants, creationTime }] }`

### [app/api/record/*.ts](app/api/record/)
Recording endpoints using `EgressClient` - **NO AUTH** (add before production).
- `start/route.ts`: Create room composite egress with S3 upload
- `stop/route.ts`: List active egresses and stop all

## Track Processors

### Background Effects ([lib/CameraSettings.tsx](lib/CameraSettings.tsx))
```typescript
import { BackgroundBlur, VirtualBackground } from '@livekit/track-processors';
cameraTrack.track?.setProcessor(BackgroundBlur());
cameraTrack.track?.setProcessor(VirtualBackground(imageSrc));
cameraTrack.track?.stopProcessor();
```

### Krisp Noise Filter ([lib/MicrophoneSettings.tsx](lib/MicrophoneSettings.tsx))
```typescript
import { useKrispNoiseFilter } from '@livekit/components-react/krisp';
const { isNoiseFilterEnabled, setNoiseFilterEnabled } = useKrispNoiseFilter({
  filterOptions: { quality: isLowPowerDevice() ? 'low' : 'medium' }
});
```

## Docker Configuration

### Dockerfile Multi-Stage Build
1. **base**: Setup pnpm with retry logic (network resilience)
2. **deps**: Install with `--frozen-lockfile`
3. **builder**: Build Next.js with `output: 'standalone'` (next.config.js)
4. **runner**: Copy standalone output + static + public

**Critical**: `next.config.js` MUST have `output: 'standalone'` for Docker deployment.

### Git LFS Images
Background images in `public/background-images/` are Git LFS pointers. If Docker build fails on image imports:
1. Install Git LFS: `sudo apt-get install git-lfs && git lfs pull`
2. Or comment out imports in [lib/CameraSettings.tsx](lib/CameraSettings.tsx#L11-L17)

## Security Considerations

### Next.js Headers ([next.config.js](next.config.js#L16-L31))
```typescript
headers: {
  'Cross-Origin-Opener-Policy': 'same-origin',
  'Cross-Origin-Embedder-Policy': 'credentialless',
}
```
**Required for**: SharedArrayBuffer (E2EE worker), WebAssembly (Krisp)

### Production Warnings
- Recording endpoints have **no authentication** - add middleware
- Access tokens have 5-minute TTL (appropriate for demo, extend for production)
- E2EE passphrases in URL are never logged server-side (by design)

## Keyboard Shortcuts
Built-in via [lib/KeyboardShortcuts.tsx](lib/KeyboardShortcuts.tsx):
- `Cmd/Ctrl + A`: Toggle microphone
- `Cmd/Ctrl + V`: Toggle camera
- `Shift + D`: Debug overlay (with Datadog integration)

## Testing
- Unit tests with Vitest: `pnpm test`
- Example: [lib/getLiveKitURL.test.ts](lib/getLiveKitURL.test.ts)
- Test utilities that parse, generate, or transform data
- No E2E tests currently in repo

## Common Patterns to Follow

### Adding a New Page
1. Create server component in `app/[name]/page.tsx` (layout, metadata)
2. Create client impl in `app/[name]/PageClientImpl.tsx` with `"use client"`
3. Use `RoomContext.Provider` pattern for LiveKit components
4. Import and use PreJoin before connecting if user setup needed

### Adding Custom Settings
1. Create component in `lib/[Name]Settings.tsx`
2. Use `useLocalParticipant()` to access tracks
3. Integrate into [lib/SettingsMenu.tsx](lib/SettingsMenu.tsx#L50-L70)
4. Follow tab/accordion structure with CSS modules

### Modifying Video Conference
Customize via props on `<VideoConference>`:
```typescript
<VideoConference 
  chatMessageFormatter={formatChatMessageLinks}  // Transform links in chat
  SettingsComponent={SettingsMenu}               // Custom settings panel
/>
```

## New Features Implementation

### "Join Existing" Tab ([app/page.tsx](app/page.tsx))
Allows users to discover and join active rooms without manual room ID entry:

**Implementation pattern:**
```typescript
// Fetch active rooms
const response = await fetch('/api/rooms/active');
const data = await response.json();
setActiveRooms(data.rooms);

// Auto-refresh with useEffect
useEffect(() => {
  fetchActiveRooms();
  const interval = setInterval(fetchActiveRooms, 5000);
  return () => clearInterval(interval);
}, []);

// Join room directly
router.push(`/rooms/${roomName}`);
```

**Features:**
- Displays room name, participant count, creation time
- Auto-refreshes every 5 seconds
- Manual refresh button
- Fallback message when no rooms exist
- Styled with consistent LiveKit theming

**Adding to tab navigation:**
1. Update `Tabs` component to handle 3rd tab index
2. Add `<JoinExistingTab label="Join Existing" />` to children
3. Tab routing: `tab=join` query parameter

## Key Files by Use Case
- **Complete room flow**: [app/rooms/[roomName]/PageClientImpl.tsx](app/rooms/[roomName]/PageClientImpl.tsx)
- **Custom connection**: [app/custom/VideoConferenceClientImpl.tsx](app/custom/VideoConferenceClientImpl.tsx)
- **Token generation**: [app/api/connection-details/route.ts](app/api/connection-details/route.ts)
- **Active rooms listing**: [app/api/rooms/active/route.ts](app/api/rooms/active/route.ts)
- **E2EE setup**: [lib/useSetupE2EE.ts](lib/useSetupE2EE.ts)
- **Performance**: [lib/usePerfomanceOptimiser.ts](lib/usePerfomanceOptimiser.ts)
- **UI components**: [lib/SettingsMenu.tsx](lib/SettingsMenu.tsx), [lib/CameraSettings.tsx](lib/CameraSettings.tsx)
- **Home page tabs**: [app/page.tsx](app/page.tsx) - Demo, Custom, Join Existing

## Docker Configuration

### Dockerfile Multi-Stage Build
1. **base**: Setup pnpm with retry logic (network resilience)
2. **deps**: Install with `--frozen-lockfile`
3. **builder**: Build Next.js with `output: 'standalone'` (critical for Docker)
4. **runner**: Copy standalone output + static + public

**Key Configuration:**
- `next.config.js` MUST have `output: 'standalone'`
- Public folder copied explicitly: `COPY --from=builder /app/public ./public`
- Standalone server runs with: `node server.js`

### Nginx HTTPS Proxy ([Dockerfile.nginx](Dockerfile.nginx))
Minimal alpine-based nginx for HTTPS termination:
```nginx
server {
    listen 8443 ssl;
    http2 on;
    ssl_certificate /etc/nginx/certs/cert.pem;
    ssl_certificate_key /etc/nginx/certs/key.pem;
    
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        # ... standard proxy headers
    }
}
```

### docker-compose.yml Configuration
```yaml
services:
  livekit:
    image: livekit/livekit-server:latest
    command: --dev --bind "0.0.0.0" --node-ip "192.168.128.8"
    network_mode: host

  meet:
    build:
      context: ./meet
      args:
        NEXT_PUBLIC_LIVEKIT_URL: ws://192.168.128.8:7880
    environment:
      - LIVEKIT_URL=ws://192.168.128.8:7880
      - LIVEKIT_API_KEY=devkey
      - LIVEKIT_API_SECRET=secret
    network_mode: host

  meet-nginx:
    build:
      context: ./meet
      dockerfile: Dockerfile.nginx
    volumes:
      - ./meet/certs:/etc/nginx/certs:ro
    network_mode: host
```

**Critical flags:**
- `--node-ip`: Required for WebRTC connections from remote devices
- `network_mode: host`: Simplifies port management, uses host network stack
- Volume mount certs as `:ro` (read-only)

### Git LFS Images Issue
Background images in `public/background-images/` are Git LFS pointers (~130 bytes).

**Workaround applied:**
```typescript
// lib/CameraSettings.tsx - Lines 11-17
// import Desk from '../public/background-images/samantha-gades-BlIhVfXbi9s-unsplash.jpg';
// import Nature from '../public/background-images/ali-kazal-tbw_KQE3Cbg-unsplash.jpg';
const BACKGROUND_IMAGES: Array<{ name: string; path: { src: string } }> = [];
```

**To restore images:**
```bash
sudo apt-get install git-lfs
git lfs pull
# Uncomment imports in CameraSettings.tsx
docker compose build meet
```

## What Makes This Project Unique
- **Production-ready**: Not a basic demo - includes E2EE, recording, noise filtering, performance optimization
- **Local network deployment**: Configured for multi-device access with proper WebRTC ICE candidates
- **HTTPS with self-signed certs**: Enables camera/mic access on remote devices without paid certificates
- **Active room discovery**: "Join Existing" tab shows live rooms without manual ID sharing
- **Zero backend**: E2EE passphrases never touch the server (URL hash pattern)
- **Automatic optimization**: Detects low-power devices and adjusts quality
- **Professional features**: Krisp noise cancellation, background effects, recording to S3
- **Regional routing**: Auto-selects closest LiveKit Cloud region
- **Debug tooling**: Shift+D overlay with Datadog integration
- **Docker optimized**: Next.js standalone build for minimal image size (~150MB)
- **Host network mode**: Simplified deployment without complex port mappings

## Deployment Summary

**Access URLs:**
- HTTPS (recommended): `https://192.168.128.8:8443`
- HTTP (limited): `http://192.168.128.8:3000`
- LiveKit WebSocket: `ws://192.168.128.8:7880`

**Security notes:**
- Self-signed certificate requires browser acceptance once per device
- Recording endpoints have no authentication (demo only)
- E2EE passphrases in URL hash are never server-logged (by design)

**Multi-user workflow:**
1. User A starts meeting → gets URL with room ID
2. User B visits home page → sees User A's room in "Join Existing" tab
3. User B clicks "Join" → enters same room without knowing ID
4. Both users see/hear each other with full video/audio/chat functionality
